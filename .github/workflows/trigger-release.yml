name: Trigger release

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Sync repo"]
    types:
      - completed

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      source_tag: ${{ steps.sourcetag.outputs.tag }}
      create_release: ${{ steps.rel-chk.outputs.create_release }}
    steps:
      - name: Find latest tag of source repo
        uses: oprypin/find-latest-tag@v1
        with:
          repository: casey/just
          regex: '^\d+\.\d+\.\d+$'
          releases-only: true 
        id: sourcetag

      - name: Find latest tag of target repo
        uses: oprypin/find-latest-tag@v1
        with:
          repository: gnpaone/rust-just
          releases-only: true 
        id: targettag

      - run: npm install semver

      - name: Check for new release
        uses: actions/github-script@v8
        id: rel-chk
        with:
          script: |
            const semver = require('semver');

            const source_tag = `${{ steps.sourcetag.outputs.tag }}`;
            const target_tag = `${{ steps.targettag.outputs.tag }}`;

            core.setOutput('create_release', semver.gt(source_tag, target_tag));

  release:
    runs-on: ubuntu-latest
    if: needs.check.outputs.create_release == 'true'
    needs: check
    steps:
      - name: Fetch source release data
        id: src_rel
        uses: actions/github-script@v8
        with:
          script: |
            const { data } = await github.rest.repos.getReleaseByTag({
              owner: "casey",
              repo: "just",
              tag: "${{ needs.check.outputs.source_tag }}"
            });
            core.setOutput("body", data.body || "");
            core.setOutput("name", data.name || "${{ needs.check.outputs.source_tag }}");

      - name: Checkout just repo to read CHANGELOG
        if: steps.src_rel.outputs.body == ''
        uses: actions/checkout@v5
        with:
          repository: casey/just
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master
          path: just_source

      - name: Extract release notes from CHANGELOG.md
        id: changelog
        if: steps.src_rel.outputs.body == ''
        run: |
          TAG="${{ needs.check.outputs.source_tag }}"
          FILE="just_source/CHANGELOG.md"

          # Extract lines until the next version heading (start of next digit)
          awk "/^${TAG} - /{flag=1; next} /^([0-9]+\.[0-9]+\.[0-9]+)/{flag=0} flag" "$FILE" > raw.txt

          # Trim whitespace
          sed -i 's/^[ \t]*//' raw.txt

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat raw.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create release (fallback)
        if: steps.src_rel.outputs.body == ''
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.repos.createRelease({
              owner: "gnpaone",
              repo: "rust-just",
              tag_name: "${{ needs.check.outputs.source_tag }}",
              name: "${{ needs.check.outputs.source_tag }}",
              body: `${{ steps.changelog.outputs.notes }}`
            });

      - name: Copy release normally
        if: steps.src_rel.outputs.body != ''
        uses: marchbold/copy-release-to-repository-action@v2
        with:
          source_repo: 'casey/just'
          destination_repo: 'gnpaone/rust-just'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.check.outputs.source_tag }}

      - name: Trigger release event
        if: |
          (steps.src_rel.outputs.body != '' && steps.copy_release.outcome == 'success') ||
          (steps.src_rel.outputs.body == '')
        uses: peter-evans/repository-dispatch@v4
        with:
          event-type: platform-release
          
