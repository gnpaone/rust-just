name: Trigger release

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Sync repo"]
    types:
      - completed

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      source_tag: ${{ steps.sourcetag.outputs.tag }}
      create_release: ${{ steps.rel-chk.outputs.create_release }}
    steps:
      - name: Find latest tag of source repo
        uses: oprypin/find-latest-tag@v1
        with:
          repository: casey/just
          regex: '^\d+\.\d+\.\d+$'
          releases-only: true 
        id: sourcetag

      - name: Find latest tag of target repo
        uses: oprypin/find-latest-tag@v1
        with:
          repository: gnpaone/rust-just
          releases-only: true 
        id: targettag

      - run: npm install semver

      - name: Check for new release
        uses: actions/github-script@v8
        id: rel-chk
        with:
          script: |
            const semver = require('semver');

            const source_tag = `${{ steps.sourcetag.outputs.tag }}`;
            const target_tag = `${{ steps.targettag.outputs.tag }}`;

            core.setOutput('create_release', semver.gt(source_tag, target_tag));

  release:
    runs-on: ubuntu-latest
    if: needs.check.outputs.create_release == 'true'
    needs: check
    steps:
      - name: Fetch source release data
        id: src_rel
        uses: actions/github-script@v8
        with:
          script: |
            const { data } = await github.rest.repos.getReleaseByTag({
              owner: "casey",
              repo: "just",
              tag: "${{ needs.check.outputs.source_tag }}"
            });
            core.setOutput("body", data.body || "");
            core.setOutput("name", data.name || "${{ needs.check.outputs.source_tag }}");

      - name: Checkout just repo to read CHANGELOG
        if: steps.src_rel.outputs.body == ''
        uses: actions/checkout@v5
        with:
          repository: casey/just
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: master
          path: just_source

      - name: Verify CHANGELOG.md contains the tag
        if: steps.src_rel.outputs.body == ''
        run: |
          TAG="${{ needs.check.outputs.source_tag }}"
          FILE="just_source/CHANGELOG.md"

          if ! grep -q "^\[${TAG}\]" "$FILE"; then
            echo "::error title=Tag not found in CHANGELOG::Could not find [${TAG}] in ${FILE}"
            exit 1
          fi

          echo "Found release header for ${TAG}"

      - name: Extract release notes from CHANGELOG.md
        id: changelog
        if: steps.src_rel.outputs.body == ''
        run: |
          TAG="${{ needs.check.outputs.source_tag }}"
          FILE="just_source/CHANGELOG.md"

          awk "/^\[${TAG}\]/ {flag=1; next} /^\[[0-9]+\.[0-9]+\.[0-9]+]/ {flag=0} flag" "$FILE" > raw.txt

          sed -i 's/^[ \t]*//' raw.txt

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat raw.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Copy release body override
        id: copy_rel_over
        if: steps.src_rel.outputs.body == ''
        uses: gnpaone/copy-repo-release@v1.0.1
        with:
          source_repo: 'casey/just'
          tag: ${{ needs.check.outputs.source_tag }}
          override_body: ${{ steps.changelog.outputs.notes }}

      - name: Copy release normally
        id: copy_rel_norm
        if: steps.src_rel.outputs.body != ''
        uses: gnpaone/copy-repo-release@v1.0.1
        with:
          source_repo: 'casey/just'
          tag: ${{ needs.check.outputs.source_tag }}

      - name: Trigger release event
        if: |
          (steps.src_rel.outputs.body != '' && steps.copy_rel_norm.outcome == 'success') ||
          (steps.src_rel.outputs.body == '' && steps.copy_rel_over.outcome == 'success')
        uses: peter-evans/repository-dispatch@v4
        with:
          event-type: platform-release
          
